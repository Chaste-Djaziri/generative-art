<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Microphone Particle Visualizer (Legacy Support)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: linear-gradient(to bottom right, #78350f, #92400e, #78350f);
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #startBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.1);
      color: #d4a574;
      border: 1px solid #d4a574;
      padding: 10px 16px;
      border-radius: 10px;
      font-family: sans-serif;
      cursor: pointer;
    }
    #startBtn:hover {
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
  <canvas id="particleCanvas"></canvas>
  <button id="startBtn">üéôÔ∏è Start Visualizer</button>

  <script>
    (function() {
      var canvas = document.getElementById('particleCanvas');
      var ctx = canvas.getContext ? canvas.getContext('2d') : null;
      var startBtn = document.getElementById('startBtn');
      var audioContext = null, analyser = null, dataArray = null, micStream = null;
      var running = false;

      if (!ctx) {
        alert('Your browser does not support HTML5 Canvas.');
        return;
      }

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      // Polyfills
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia ||
                               navigator.webkitGetUserMedia ||
                               navigator.mozGetUserMedia ||
                               navigator.msGetUserMedia;

      if (!navigator.getUserMedia) {
        alert('Microphone access is not supported in this browser.');
      }

      function createParticle() {
        return {
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          vx: (Math.random() - 0.5) * 1.5,
          vy: (Math.random() - 0.5) * 1.5,
          radius: Math.random() * 2 + 2
        };
      }

      var particleCount = 120;
      var particles = [];
      for (var i = 0; i < particleCount; i++) {
        particles.push(createParticle());
      }
      var connectionDistance = 150;

      function startVisualizer() {
        if (!window.AudioContext || !navigator.getUserMedia) {
          alert('Your browser does not support required audio APIs.');
          return;
        }
        navigator.getUserMedia(
          { audio: true },
          function(stream) {
            try {
              audioContext = new AudioContext();
              var source = audioContext.createMediaStreamSource(stream);
              analyser = audioContext.createAnalyser();
              analyser.fftSize = 256;
              var bufferLength = analyser.frequencyBinCount;
              dataArray = new Uint8Array(bufferLength);
              source.connect(analyser);
              running = true;
              startBtn.style.display = 'none';
              animate();
            } catch (e) {
              alert('Audio initialization failed: ' + e.message);
            }
          },
          function(err) {
            alert('Microphone access denied or unavailable.');
            console.log(err);
          }
        );
      }

      startBtn.onclick = startVisualizer;

      function animate() {
        if (!running) return;
        requestAnimationFrame(animate);

        ctx.fillStyle = 'rgba(42, 25, 13, 0.15)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (analyser) {
          analyser.getByteFrequencyData(dataArray);
        }
        var avg = 0;
        if (dataArray) {
          var sum = 0;
          for (var i = 0; i < dataArray.length; i++) sum += dataArray[i];
          avg = sum / dataArray.length;
        }
        var beatStrength = avg / 255;

        for (var p = 0; p < particles.length; p++) {
          var part = particles[p];
          part.x += part.vx;
          part.y += part.vy;

          if (part.x < 0 || part.x > canvas.width) part.vx *= -1;
          if (part.y < 0 || part.y > canvas.height) part.vy *= -1;

          var scale = 1 + beatStrength * 1.8;
          ctx.beginPath();
          ctx.arc(part.x, part.y, part.radius * scale, 0, Math.PI * 2, false);
          ctx.fillStyle = 'rgba(212,165,116,' + (0.6 + beatStrength * 0.6) + ')';
          ctx.fill();
        }

        ctx.lineWidth = 1.2;
        for (var i = 0; i < particles.length; i++) {
          for (var j = i + 1; j < particles.length; j++) {
            var dx = particles[i].x - particles[j].x;
            var dy = particles[i].y - particles[j].y;
            var distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < connectionDistance) {
              var opacity = (1 - distance / connectionDistance) * 0.5 * (1 + beatStrength);
              ctx.strokeStyle = 'rgba(139,90,43,' + opacity + ')';
              ctx.beginPath();
              ctx.moveTo(particles[i].x, particles[i].y);
              ctx.lineTo(particles[j].x, particles[j].y);
              ctx.stroke();
            }
          }
        }
      }
    })();
  </script>
</body>
</html>
